- name: Create necessary directory for Quay local storage
  ansible.builtin.file:
    path: "{{ quay_root }}/quay-storage"
    state: directory
    recurse: yes

- name: Create necessary directory for Quay config bundle
  ansible.builtin.file:
    path: "{{ quay_root }}/quay-config"
    state: directory
    recurse: yes

- name: Set permissions on local storage directory
  ansible.posix.acl:
    path: "{{ quay_root }}/quay-storage"
    entry: u:1001:-wx
    state: present

- name: Copy Quay config.yaml file
  template:
    src: ../templates/config.yaml.j2
    dest: "{{ quay_root }}/quay-config/config.yaml"

- name: Check if SSL Cert exists
  stat:
    path: /runner/certs/quay.cert
  delegate_to: localhost
  register: ssl_cert

- name: Check if SSL Key exists
  stat:
    path: /runner/certs/quay.key
  delegate_to: localhost
  register: ssl_key

- name: Create SSL Certs
  block:
    - name: Create CSR
      template:
        src: ../templates/req.j2
        dest: "{{ quay_root }}/quay-config/req"

    - name: Creating self-signed cert
      command: "openssl req -new -nodes -x509 -days 365 -keyout {{ quay_root }}/quay-config/ssl.key -out {{ quay_root }}/quay-config/ssl.cert -config {{ quay_root }}/quay-config/req"
  when: (ssl_cert.stat.exists == False) and (ssl_key.stat.exists == False)

- name: Copy SSL Certs
  block:
    - name: Copy SSL certificate
      copy:
        src: /runner/certs/quay.cert
        dest: "{{ quay_root }}/quay-config/ssl.cert"

    - name: Copy SSL key
      copy:
        src: /runner/certs/quay.key
        dest: "{{ quay_root }}/quay-config/ssl.key"
  when: (ssl_cert.stat.exists == True) and (ssl_key.stat.exists == True)

- name: Set certificate permissions
  block:
    - name: Set permissions for key
      ansible.builtin.file:
        path: "{{ quay_root }}/quay-config/ssl.key"
        mode: u=rw,g=r,o=r
        owner: root
        group: root

    - name: Set permissions for cert
      ansible.builtin.file:
        path: "{{ quay_root }}/quay-config/ssl.cert"
        mode: u=rw,g=r,o=r
        owner: root
        group: root

- name: Copy Quay systemd service file
  template:
    src: ../templates/quay.service.j2
    dest: /etc/systemd/system/quay-app.service

- name: Check if Quay image is loaded
  command: podman inspect --type=image {{ quay_image }}
  register: q
  ignore_errors: yes

- name: Pull Quay image
  containers.podman.podman_image:
    name: "{{ quay_image }}"
  when: q.rc != 0

- name: Start Quay service
  systemd:
    name: quay-app.service
    enabled: yes
    daemon_reload: yes
    state: started
